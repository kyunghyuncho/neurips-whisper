<!--
    NeurIPS Whisper - Main Application Template
    
    This is the single-page application template that handles both:
    1. Unauthenticated state: Login form
    2. Authenticated state: Live message feed with real-time updates
    
    Key Technologies:
    - HTMX: For seamless AJAX interactions without writing JavaScript
    - SSE Extension: For real-time Server-Sent Events streaming
    - Jinja2: Server-side templating with conditional rendering and loops
    - Vanilla JavaScript: For UI interactions (modals, toggles)
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- Viewport meta for responsive design on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeurIPS Whisper</title>

    <!-- HTMX Core Library - Enables declarative AJAX, SSE, and more -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- HTMX SSE Extension - Adds Server-Sent Events support for real-time feeds -->
    <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>

    <!-- Custom CSS Styles -->
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* Unread notification highlight */
        .unread-notification {
            background-color: #eff6ff !important;
            border-left: 3px solid #6366f1 !important;
        }

        /* Refresh button hover effect */
        button[title="Refresh notifications"]:hover {
            color: #4b5563 !important;
        }

        /* Tom Select Customization */
        .ts-control {
            background-color: transparent !important;
            border: none !important;
            padding: 0 !important;
            box-shadow: none !important;
        }

        .ts-control .item {
            color: #6b7280 !important;
            font-size: 0.75rem !important;
        }

        .ts-dropdown {
            font-size: 0.875rem !important;
            font-size: 0.875rem !important;
            z-index: 1000 !important;
        }

        /* View Toggle Styles */
        .toggle-btn.active {
            background-color: white;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-weight: 600;
            color: #4f46e5 !important;
        }
    </style>
    <!-- Tom Select for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.default.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
</head>

<body>
    <div class="container">
        <!-- Application Header - Always Visible -->
        <div class="header">
            <h1>NeurIPS Whisper</h1>
            <p class="subtitle">Developed by Kyunghyun Cho under KC Explorer LLC</p>
            <div style="margin-top: 0.25rem; max-width: 250px; margin-left: auto; margin-right: auto;">
                <select id="timezone-selector"
                    style="font-size: 0.75rem; color: #6b7280; background: transparent; border: none; cursor: pointer;"
                    aria-label="Select Timezone">
                </select>
            </div>
        </div>

        <!--
            =================================================================
            CONDITIONAL RENDERING: Login Form vs. Feed
            =================================================================
            
            Jinja2 conditional checks authentication status:
            - If user is NOT logged in: Show login form
            - If user IS logged in: Show live feed interface
        -->

        {% if not user %}
        <!--
            ===================== UNAUTHENTICATED STATE =====================
            Login Form - Magic Link Authentication
        -->
        <div id="login-section">
            <h2>Login</h2>

            <!-- Error Display for Login Failures -->
            <div id="login-error" style="color: #ef4444; margin-bottom: 1rem; font-size: 0.875rem; display: none;">
            </div>

            <!-- 
                HTMX Form Submission:
                - hx-post="/auth/login": Posts to login endpoint  
                - hx-swap="outerHTML": Replaces this entire form with server response
                  (Server returns magic_link_sent.html partial on success)
            -->
            <form hx-post="/auth/login" hx-swap="outerHTML">
                <div class="form-group">
                    <label>Email</label>
                    <!-- Email validation enforced by HTML5 type="email" -->
                    <input type="email" name="email" required placeholder="your.name@institution.edu">
                </div>
                <div class="form-group">
                    <label>Conference Code</label>
                    <!-- Secret code gates access to authorized attendees only -->
                    <input type="text" name="conference_code" required placeholder="Enter code">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="agree_terms" required>
                        <span>I agree to the <button type="button" class="btn-link"
                                onclick="document.getElementById('terms-modal').classList.add('active')">Terms of
                                Use</button></span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">
                    Get Magic Link
                </button>
            </form>
        </div>
        {% else %}
        <!--
            ===================== AUTHENTICATED STATE =====================
            Live Feed Interface with Real-time Updates
        -->
        <div id="feed-section">
            <!-- Feed Header with Actions -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <h2>Live Feed</h2>
                    {% include "partials/view_toggle.html" %}
                </div>
                <div>
                    <!-- Data download link (available to all users) -->
                    <a href="/feed/download" class="btn-link"
                        style="font-size: 0.875rem; margin-right: 1rem;">Download</a>
                    <!-- Audit logs link (superusers only) -->
                    {% if user.is_superuser %}
                    <a href="/feed/audit_logs" class="btn-link"
                        style="font-size: 0.875rem; margin-right: 1rem;">Logs</a>
                    {% endif %}
                    <!-- Logout link -->
                    <a href="/auth/logout" class="btn-link" style="font-size: 0.875rem;">Logout</a>
                </div>
            </div>

            <!--
                Three-Column Feed Layout:
                1. Left Sidebar: User's personal messages
                2. Main Feed: All messages with posting interface
                3. Right Sidebar: Trending hashtags
            -->
            <div class="feed-layout">
                <!-- ========== LEFT SIDEBAR: My Messages ========== -->
                <div class="left-sidebar">
                    <div id="my-messages-section">
                        <!-- Notification Panel with polling and manual refresh -->
                        <div id="notification-panel-container" hx-get="/feed/notifications" hx-trigger="load, every 30s"
                            hx-swap="innerHTML">
                            <div class="htmx-indicator">Loading notifications...</div>
                        </div>

                        <h3>My Messages</h3>
                        <!--
                            HTMX Auto-loading Div:
                            - hx-get="/feed/my_messages": Loads user's messages
                            - hx-trigger="load": Fetches on page load
                            - hx-trigger="updateMyMessages from:body": Refetches when custom event fires
                              (Event is triggered after posting or starring)
                        -->
                        <div hx-get="/feed/my_messages" hx-trigger="load, updateMyMessages from:body">
                            <div class="htmx-indicator">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- ========== MAIN FEED COLUMN ========== -->
                <div class="feed-main">
                    <!-- Error Display for Failed Posts -->
                    <div id="post-error"
                        style="color: #ef4444; margin-bottom: 0.5rem; font-size: 0.875rem; display: none;">
                    </div>

                    <!-- Message Posting Form -->
                    <form hx-post="/feed/post" hx-swap="none" style="margin-bottom: 1rem;">
                        <div style="position: relative;">
                            <!-- Text area with character limit -->
                            <textarea id="post-content" name="content" rows="3" placeholder="What's happening?"
                                maxlength="140" required style="width: 100%;"
                                oninput="updateCharCounter(this)"></textarea>
                            <!-- Character counter (updated by JavaScript) -->
                            <div id="char-counter"
                                style="text-align: right; font-size: 0.8rem; color: #666; margin-top: 0.25rem;">0/140
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="margin-top: 0.5rem;">
                            Post
                        </button>
                    </form>

                    <!-- Search Bar -->
                    <div class="search-bar" style="margin-bottom: 1rem;">
                        <!--
                            HTMX Search Input:
                            - hx-get: Fetches filtered feed
                            - hx-trigger="keyup changed delay:500ms": Debounced search (waits 500ms after typing stops)
                            - hx-target="#feed-wrapper": Updates the feed container
                            - hx-push-url="true": Updates browser URL for shareable links
                        -->
                        <input type="text" name="search" placeholder="Search messages..." class="form-control"
                            style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                            hx-get="/feed/container?view={{ view }}{% if tags_query %}&{{ tags_query }}{% endif %}"
                            hx-trigger="keyup changed delay:500ms, search" hx-target="#feed-wrapper" hx-swap="outerHTML"
                            hx-push-url="true" value="{{ search or '' }}">
                    </div>

                    <!-- Feed Container (includes feed_container.html partial with SSE) -->
                    {% include "partials/feed_container.html" %}
                </div>

                <!-- ========== RIGHT SIDEBAR: Trending Hashtags ========== -->
                <div class="hashtag-sidebar">
                    <!--
                        HTMX Auto-refreshing Hashtags:
                        - hx-trigger="load": Initial load
                        - hx-trigger="every 60s": Refresh every minute
                        - hx-trigger="updateHashtags from:body": Refresh on custom events
                    -->
                    <div hx-get="/feed/hashtags{% if tags_query %}?{{ tags_query }}{% endif %}"
                        hx-trigger="load, every 60s, updateHashtags from:body">
                        <div class="htmx-indicator">Loading trends...</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>



    <!-- Terms of Use Modal -->
    <div id="terms-modal" class="modal-overlay">
        <div class="modal">
            <h3>Terms of Use</h3>
            <ul>
                <li>Messages are immutable (cannot be deleted/edited).</li>
                <li>Data is ephemeral: All data will be wiped 48 hours after the conference ends.</li>
                <li>No scraping, archiving, or using this data for model training.</li>
            </ul>
            <button id="ok-btn" onclick="document.getElementById('terms-modal').classList.remove('active')"
                class="btn btn-primary">
                OK
            </button>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="modal-overlay {% if focused_message %}active{% endif %}">
        <div class="modal">
            <div id="message-modal-content">
                {% if focused_message %}
                <!-- Initial render for focused message (deep link) -->
                <!-- Render the full feed item with all metadata -->
                {% with content=focused_message.content, created_at=focused_message.created_at,
                created_at_iso=focused_message.created_at_iso,
                author=focused_message.author, id=focused_message.id, user_id=focused_message.user_id, replies=[],
                is_starred=False, expanded=True, user=user, in_modal=True %}
                {% include "partials/feed_item.html" %}
                {% endwith %}
                {% endif %}
            </div>
            <div id="message-modal-meta" style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                <button class="copy-link-btn" onclick="copyPermalink()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1">
                        </path>
                    </svg>
                    Copy Link
                </button>
            </div>
            <div style="margin-top: 1.5rem; text-align: right;">
                <button onclick="closeMessageModal()" class="btn btn-primary">Close</button>
            </div>
        </div>
    </div>

    <!--
        =================================================================
        JAVASCRIPT - UI Interactions and Event Handling
        =================================================================
        
        This script handles client-side interactions that aren't covered by HTMX:
        - Modal opening/closing with URL updates
        - Permalink copying
        - Character counter updates
        - Hashtag filtering navigation
        - Reply form toggling
        - Thread expansion/collapse
        - HTMX event listeners for post errors
    -->
    <script>
        // Track the currently viewed message ID for permalink generation
        let currentMessageId = {% if focused_message %}{ { focused_message.id } } {% else %} null{% endif %};

        // If page loaded with a focused message (deep link like /?msg=123), fetch its thread
        {% if focused_message %}
        document.addEventListener('DOMContentLoaded', function () {
            // Use HTMX's ajax() method to fetch thread and inject into modal
            htmx.ajax('GET', '/feed/thread/{{ focused_message.id }}', '#message-modal-content');
        });
        {% endif %}

        /**
         * Open message modal and load thread
         * Called when clicking a message in the feed
         * 
         * @param {HTMLElement} element - The feed-item div that was clicked
         */
        function openMessageModal(element) {
            // Get message ID from data attribute
            const id = element.dataset.id;
            currentMessageId = id;

            // Show loading state
            document.getElementById('message-modal-content').innerHTML = '<div class="htmx-indicator">Loading thread...</div>';
            document.getElementById('message-modal').classList.add('active');

            // Fetch full thread from server using HTMX
            htmx.ajax('GET', '/feed/thread/' + id, { target: '#message-modal-content', swap: 'innerHTML' }).then(() => {
                // Scroll to focused message after content is loaded
                setTimeout(() => {
                    const focusedEl = document.getElementById('focused-message-el');
                    if (focusedEl) {
                        focusedEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Add a temporary highlight effect
                        focusedEl.style.transition = 'background-color 0.5s';
                        const originalBg = focusedEl.style.backgroundColor;
                        focusedEl.style.backgroundColor = '#e0e7ff'; // Light indigo
                        setTimeout(() => {
                            focusedEl.style.backgroundColor = originalBg;
                        }, 2000);
                    }
                }, 100); // Small delay to ensure DOM update
            });

            // Update URL to make modal shareable
            // This adds ?msg=ID to URL without triggering page reload
            const url = new URL(window.location);
            url.searchParams.set('msg', id);
            window.history.pushState({}, '', url);
        }

        /**
         * Close message modal and clean up URL
         */
        function closeMessageModal() {
            console.log('closeMessageModal called');
            document.getElementById('message-modal').classList.remove('active');

            // Remove ?msg parameter from URL
            const url = new URL(window.location);
            url.searchParams.delete('msg');
            window.history.pushState({}, '', url);
        }

        /**
         * Copy permalink URL to clipboard
         * Called from "Copy Link" button in modal
         */
        function copyPermalink() {
            if (!currentMessageId) return;

            // Build shareable URL with message ID
            const url = window.location.origin + "/?msg=" + currentMessageId;

            // Use Clipboard API (modern browsers)
            navigator.clipboard.writeText(url).then(() => {
                // Provide user feedback by temporarily changing button text
                const btn = document.querySelector('.copy-link-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'Copied!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        }

        // Close modal when clicking outside content area (on overlay)
        document.getElementById('message-modal').addEventListener('click', function (e) {
            if (e.target === this) {  // Clicked the overlay, not the modal content
                closeMessageModal();
            }
        });

        /**
         * HTMX Event Listener: Handle post errors
         * Displays error messages when message posting fails
         */
        document.body.addEventListener('htmx:responseError', function (evt) {
            // Handle errors from the post form
            if (evt.target.getAttribute('hx-post') === '/feed/post') {
                const errorDiv = document.getElementById('post-error');
                try {
                    // Try to parse error message from server response
                    const response = JSON.parse(evt.detail.xhr.responseText);
                    errorDiv.textContent = response.detail || "An error occurred";
                    errorDiv.style.display = 'block';
                } catch (e) {
                    // Fallback if response isn't valid JSON
                    errorDiv.textContent = "An error occurred";
                    errorDiv.style.display = 'block';
                }
            }

            // Handle errors from the login form
            if (evt.target.getAttribute('hx-post') === '/auth/login') {
                const errorDiv = document.getElementById('login-error');
                try {
                    // Try to parse error message from server response
                    const response = JSON.parse(evt.detail.xhr.responseText);
                    errorDiv.textContent = response.detail || "An error occurred";
                    errorDiv.style.display = 'block';
                } catch (e) {
                    // Fallback if response isn't valid JSON
                    errorDiv.textContent = "An error occurred";
                    errorDiv.style.display = 'block';
                }
            }
        });

        /**
         * HTMX Event Listener: Handle successful posts
         * Clears form and hides error messages after posting
         */
        document.body.addEventListener('htmx:afterRequest', function (evt) {
            if (evt.target.getAttribute('hx-post') === '/feed/post') {
                if (evt.detail.successful) {
                    // Hide any error messages
                    document.getElementById('post-error').style.display = 'none';

                    // Reset the form
                    evt.target.reset();

                    // Reset character counter to 0/140
                    const counter = document.getElementById('char-counter');
                    if (counter) counter.textContent = '0/140';
                }
            }
        });

        /**
         * Update character counter as user types
         * Called on every keystroke in the post textarea
         * 
         * @param {HTMLTextAreaElement} textarea - The textarea being monitored
         */
        function updateCharCounter(textarea) {
            const maxLength = textarea.getAttribute('maxlength');
            const currentLength = textarea.value.length;
            const counter = document.getElementById('char-counter');
            counter.textContent = `${currentLength}/${maxLength}`;
        }

        /**
         * Navigate to filtered feed by hashtag
         * Called when clicking hashtag links in message content
         * 
         * @param {string} tag - Hashtag name (without # symbol)
         */
        function toggleHashtag(tag) {
            const url = new URL(window.location);
            const params = new URLSearchParams(url.search);

            // Check if tag is already selected
            let tags = params.getAll('tags');
            if (!tags.includes(tag)) {
                // Add tag to URL parameters
                params.append('tags', tag);
                // Preserve any existing search query
                url.search = params.toString();
                // Navigate to filtered view
                window.location.href = url.toString();
            }
        }

        /**
         * Toggle reply form visibility
         * Shows/hides the reply textarea for a specific message
         * 
         * @param {HTMLElement} element - Button that was clicked
         */
        function toggleReplyForm(element) {
            // Navigate up DOM to find parent message container
            const feedItem = element.closest('.feed-item');
            if (!feedItem) return;

            // Find reply form within this specific message
            const formContainer = feedItem.querySelector('.reply-form-container');
            if (!formContainer) return;

            if (formContainer.style.display === 'none') {
                // Show form and focus textarea for immediate typing
                formContainer.style.display = 'block';
                const textarea = formContainer.querySelector('textarea');
                if (textarea) textarea.focus();
            } else {
                formContainer.style.display = 'none';
            }
        }

        /**
         * Toggle replies visibility (expand/collapse thread)
         * Shows/hides nested replies for a message
         * 
         * @param {HTMLElement} element - Button that was clicked
         */
        function toggleReplies(element) {
            const feedItem = element.closest('.feed-item');
            if (!feedItem) return;

            const repliesContainer = feedItem.querySelector('.feed-replies');
            const toggleBtn = feedItem.querySelector('.reply-toggle-btn');

            if (!repliesContainer) return;

            if (repliesContainer.style.display === 'none') {
                // Show replies
                repliesContainer.style.display = 'block';
                if (toggleBtn) toggleBtn.textContent = 'Hide replies';
            } else {
                // Hide replies
                repliesContainer.style.display = 'none';

                // Update button text to show count
                const count = repliesContainer.querySelectorAll('.feed-item').length;
                if (toggleBtn) toggleBtn.textContent = 'Show ' + count + ' replies';
            }
        }

        /**
         * Handle successful reply submission
         * Called via hx-on::after-request on the reply form
         * 
         * @param {HTMLFormElement} form - The reply form that was submitted
         */
        function handleReplySuccess(form) {
            // Find parent message container
            const feedItem = form.closest('.feed-item');
            if (!feedItem) return;

            const messageId = feedItem.dataset.id;
            const repliesContainer = feedItem.querySelector('.feed-replies');
            const toggleBtn = feedItem.querySelector('.reply-toggle-btn');
            const formContainer = feedItem.querySelector('.reply-form-container');

            // Hide the reply form
            if (formContainer) formContainer.style.display = 'none';

            // Fetch updated replies
            htmx.ajax('GET', '/feed/messages/' + messageId + '/replies', {
                target: repliesContainer,
                swap: 'innerHTML'
            }).then(() => {
                // Show replies container
                repliesContainer.style.display = 'block';

                // Update toggle button text
                if (toggleBtn) {
                    toggleBtn.textContent = 'Hide replies';
                    toggleBtn.style.display = 'inline-block';
                }
            });
        }

        /**
         * Request notification permission on load
         */
        document.addEventListener('DOMContentLoaded', function () {
            if ("Notification" in window) {
                if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                    Notification.requestPermission();
                }
            }
        });

        /**
         * Handle incoming notification data from SSE
         * Triggered when #notification-data is updated by HTMX
         */
        document.body.addEventListener('htmx:afterSwap', function (evt) {
            if (evt.target.id === 'notification-data') {
                try {
                    const data = JSON.parse(evt.target.textContent);

                    // Check if this is a reply to the current user
                    // We need the current user's ID, which we can get from the page context or a data attribute
                    // For now, let's assume we can check if parent_author_id matches
                    // Note: In a real app, we'd probably want to pass current_user.id to JS more explicitly

                    // Trigger HTMX update for notifications if it's a reply to us
                    // The server sends "updateNotifications" in HX-Trigger header for the poster,
                    // but for the recipient (via SSE), we need to trigger it manually here.
                    // However, since we don't easily know our own ID here without rendering it,
                    // we'll rely on the fact that the server *could* send a specific event for us,
                    // or we just refresh notifications on every message (less efficient but works).

                    // Better approach: Just trigger the event. The server endpoint filters by user anyway.
                    // If we get a new message, we might as well check for notifications.
                    document.body.dispatchEvent(new Event('updateNotifications'));

                    if ("Notification" in window && Notification.permission === "granted") {
                        const notification = new Notification(data.title, {
                            body: data.body,
                            tag: data.tag,
                            icon: '/static/favicon.ico' // Assuming favicon exists, or browser default
                        });

                        // Optional: Play sound or visual cue based on tag (low vs high level)
                        if (data.tag === 'reply') {
                            // High-level notification logic (e.g. keep open longer, different sound)
                            // Browser APIs are limited here, but we can differentiate in logic
                        }
                    }
                } catch (e) {
                    console.error("Error parsing notification data", e);
                }
            }
        });

        // Store TomSelect instance globally so we can access it
        let timezoneSelector = null;

        /**
         * Initialize Timezone Selector
         */
        function initTimezoneSelector() {
            const selector = document.getElementById('timezone-selector');
            if (!selector) return;

            // Get all supported timezones
            let timezones = [];
            if (typeof Intl.supportedValuesOf === 'function') {
                timezones = Intl.supportedValuesOf('timeZone');
            } else {
                // Fallback for older browsers
                timezones = [
                    "UTC", "America/New_York", "America/Los_Angeles", "America/Chicago",
                    "Europe/London", "Europe/Paris", "Asia/Tokyo", "Asia/Seoul", "Australia/Sydney"
                ];
            }

            // Populate dropdown
            const fragment = document.createDocumentFragment();
            timezones.forEach(tz => {
                const option = document.createElement('option');
                option.value = tz;
                option.textContent = tz.replace(/_/g, ' ');
                fragment.appendChild(option);
            });
            selector.appendChild(fragment);

            // Set initial value
            const savedTz = localStorage.getItem('neurips_whisper_timezone');
            const systemTz = Intl.DateTimeFormat().resolvedOptions().timeZone;

            if (savedTz && timezones.includes(savedTz)) {
                selector.value = savedTz;
            } else if (timezones.includes(systemTz)) {
                selector.value = systemTz;
            } else {
                selector.value = "UTC";
            }

            // Initialize Tom Select and store the instance
            timezoneSelector = new TomSelect('#timezone-selector', {
                create: false,
                sortField: {
                    field: "text",
                    direction: "asc"
                },
                maxOptions: null,
                render: {
                    item: function (data, escape) {
                        return '<div>' + escape(data.text) + '</div>';
                    }
                },
                onChange: function (value) {
                    // Save to localStorage and update timestamps when timezone changes
                    localStorage.setItem('neurips_whisper_timezone', value);
                    updateLocalTimes();
                }
            });
        }

        /**
         * Update all timestamps to local time
         */
        function updateLocalTimes() {
            // Get timezone from TomSelect instance or fallback
            let timezone;
            if (timezoneSelector && timezoneSelector.getValue()) {
                timezone = timezoneSelector.getValue();
            } else {
                const selector = document.getElementById('timezone-selector');
                timezone = selector && selector.value ? selector.value : Intl.DateTimeFormat().resolvedOptions().timeZone;
            }

            // Update all timestamps
            document.querySelectorAll('.local-time').forEach(el => {
                const isoTimestamp = el.dataset.timestamp;
                if (!isoTimestamp) return;

                try {
                    // CRITICAL FIX: Backend sends naive ISO timestamps (no 'Z' suffix)
                    // We need to explicitly mark them as UTC by appending 'Z'
                    // Otherwise, JavaScript interprets them as local time!
                    const utcTimestamp = isoTimestamp.endsWith('Z') ? isoTimestamp : isoTimestamp + 'Z';
                    const date = new Date(utcTimestamp);

                    // Format: "Oct 24, 12:34 PM"
                    const formatted = date.toLocaleString(undefined, {
                        timeZone: timezone,
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit'
                    });
                    el.textContent = formatted;
                    el.title = `${date.toLocaleString(undefined, { timeZone: timezone })} (${timezone})`;
                } catch (e) {
                    console.error("Error formatting date", e);
                }
            });
        }

        // Run on load
        document.addEventListener('DOMContentLoaded', function () {
            initTimezoneSelector();
            updateLocalTimes();
        });

        // Run after HTMX swaps (for new messages)
        document.body.addEventListener('htmx:afterSwap', function (evt) {
            // Small delay to ensure DOM is ready
            setTimeout(updateLocalTimes, 10);
        });

    </script>
</body>

</html>