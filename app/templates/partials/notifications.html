<!--
    Notification Panel Partial
    
    Displays a list of notifications (replies) for the user.
    Loaded via HTMX into the left sidebar.
-->
{% if notifications %}
<div
    style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0 0.5rem; padding-left: 0.5rem;">
    <h4 style="margin: 0; color: #6b7280; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">
        Notifications
    </h4>
    <button hx-get="/feed/notifications" hx-target="#notification-panel-container" hx-swap="innerHTML"
        style="background: none; border: none; cursor: pointer; padding: 0.25rem; color: #6b7280; display: flex; align-items: center;"
        title="Refresh notifications">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
            </path>
        </svg>
    </button>
</div>
<div
    style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem;">
    {% for notif in notifications %}
    <div class="feed-item {% if not notif.is_read %}unread-notification{% endif %}"
        style="cursor: pointer; position: relative;" data-notification-id="{{ notif.id }}"
        data-message-id="{{ notif.message_id }}" onclick="handleNotificationClick(this)">
        <div class="message-header">
            <span class="author">{{ notif.author }}</span>
            <span class="timestamp">{{ notif.created_at }}</span>
        </div>
        <div class="message-content" style="font-size: 0.875rem; color: #4b5563;">
            <strong style="color: #6366f1;">New reply:</strong> {{ notif.content }}
        </div>
        {% if not notif.is_read %}
        <div class="unread-dot"
            style="position: absolute; top: 50%; right: 0.75rem; transform: translateY(-50%); width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%;">
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<script>
    function handleNotificationClick(element) {
        const notificationId = element.dataset.notificationId;
        const messageId = element.dataset.messageId;

        // 1. Open the message modal
        const dummyEl = document.createElement('div');
        dummyEl.dataset.id = messageId;
        openMessageModal(dummyEl);

        // 2. Mark as read via HTMX (invisible request)
        if (element.classList.contains('unread-notification')) {
            htmx.ajax('POST', '/feed/notifications/' + notificationId + '/read', { swap: 'none' });

            // Update UI immediately
            element.classList.remove('unread-notification');
            const dot = element.querySelector('.unread-dot');
            if (dot) dot.remove();
        }
    }
</script>