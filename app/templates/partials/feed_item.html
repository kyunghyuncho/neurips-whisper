<!--
    Feed Item Component - Recursive Message Display
    
    This is the core message component used throughout the application.
    It's designed to be RECURSIVE - it includes itself to display nested replies,
    creating threaded conversations of arbitrary depth.
    
    Key Features:
    - Click-to-open modal (unless in_modal=True)
    - Conditional admin controls (delete, ban) for superusers
    - Star/unstar functionality
    - Threaded reply support (recursive)
    - Collapsible reply threads
    - Reply form toggle
    
    Context Variables (passed via Jinja2 'with' block):
    - content: Message HTML content (already linkified)
    - created_at: Timestamp string
    - author: User's email address
    - id: Message ID
    - user_id: Author's user ID
    - replies: List of child Message objects (nested replies)
    - is_starred: Boolean - whether current user starred this
    - expanded: Boolean - whether to show replies by default
    - user: Current user object (for permissions)
    - in_modal: Boolean - whether message is in modal (disables click-to-open)
    - hide_delete: Boolean - whether to hide delete button (for sidebar)
-->
<div class="feed-item" {% if not in_modal %}onclick="openMessageModal(this)" {% endif %} data-id="{{ id }}"
    data-author="{{ author }}" data-timestamp="{{ created_at }}">

    <!-- Message Header: Avatar + Author + Timestamp + Admin Controls -->
    <div class="feed-header" style="display: flex; align-items: center;">
        <!-- User Avatar Icon -->
        <div class="feed-avatar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
        </div>

        <!-- Author and Timestamp Info -->
        <div class="feed-meta">
            <span class="feed-author">{{ author }}</span>

            <!-- Superuser Only: Ban User Button -->
            {% if user and user.is_superuser and user_id %}
            <button class="icon-btn ban-btn" hx-post="/feed/ban/{{ user_id }}"
                hx-confirm="Are you sure you want to ban this user? This will delete all their messages."
                title="Ban User" onclick="event.stopPropagation()">
                <!-- Prohibition circle icon -->
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07" />
                </svg>
            </button>
            {% endif %}

            <span class="feed-timestamp local-time" data-timestamp="{{ created_at_iso }}"
                title="{{ created_at }} UTC">{{ created_at }}</span>
        </div>

        <!-- Right-aligned Action Buttons -->
        <div style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem;">
            <!-- Superuser Only: Delete Message Button -->
            {% if user and user.is_superuser and not hide_delete %}
            <button class="icon-btn delete-btn" hx-delete="/feed/message/{{ id }}" hx-swap="outerHTML"
                hx-target="closest .feed-item" hx-confirm="Are you sure you want to delete this message?"
                title="Delete Message" onclick="event.stopPropagation()">
                <!-- Trash can icon -->
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6" />
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                    <line x1="10" y1="11" x2="10" y2="17" />
                    <line x1="14" y1="11" x2="14" y2="17" />
                </svg>
            </button>
            {% endif %}

            <!-- Star Button (always visible for authenticated users) -->
            {% include "partials/star_button.html" %}
        </div>
    </div>

    <!-- Message Content -->
    <!-- | safe filter allows HTML from linkification to render -->
    <div class="feed-content">
        {{ content | safe }}
    </div>

    <!-- Action Buttons: Reply, Show/Hide Replies -->
    <div class="feed-actions" style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
        <!-- Reply button - toggles reply form -->
        <button onclick="event.stopPropagation(); toggleReplyForm(this)" class="action-btn">Reply</button>

        <!-- Show Replies Button -->
        <!-- Hidden if no replies or if already expanded -->
        <button onclick="event.stopPropagation(); toggleReplies(this)" class="action-btn reply-toggle-btn"
            style="{% if not replies or expanded %}display: none;{% endif %}">
            {% if replies %}
            Show {{ replies|length }} replies
            {% else %}
            Show replies
            {% endif %}
        </button>

        <!-- Hide Replies Button (only shown when expanded and has replies) -->
        {% if expanded and replies %}
        <button onclick="event.stopPropagation(); toggleReplies(this)" class="action-btn">Hide replies</button>
        {% endif %}
    </div>

    <!-- Reply Form (Initially Hidden) -->
    <!-- onclick="event.stopPropagation()" prevents modal from opening when interacting with form -->
    <div class="reply-form-container" style="display: none; margin-top: 0.5rem; margin-left: 1rem;"
        onclick="event.stopPropagation()">
        <!-- HTMX form posts reply to server -->
        <!-- hx-swap="none" means no DOM update (feed gets new reply via SSE instead) -->
        <!-- hx-on::after-request handles the UI update manually -->
        <form hx-post="/feed/post" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) handleReplySuccess(this)">
            <!-- Hidden field identifies parent message -->
            <input type="hidden" name="parent_id" value="{{ id }}">
            <textarea name="content" rows="2" class="w-full p-2 border rounded text-sm"
                placeholder="Write a reply..."></textarea>
            <button type="submit" class="action-btn mt-1">Post Reply</button>
        </form>
    </div>

    <!-- Nested Replies Container (Recursive!) -->
    <!-- This is where the magic happens - feed_item includes itself for replies -->
    <!-- Creates visual threading with left border and indentation -->
    <div class="feed-replies"
        style="{% if not expanded %}display: none;{% endif %} margin-left: 1.5rem; border-left: 2px solid #e5e7eb; padding-left: 0.5rem; margin-top: 0.5rem;">
        {% if replies %}
        {% for reply in replies %}
        <!-- RECURSIVE INCLUSION: feed_item.html includes itself -->
        <!-- This creates unlimited nesting depth for threaded conversations -->
        {% with content=reply.content, created_at=reply.created_at, author=reply.author, id=reply.id,
        user_id=reply.user_id,
        replies=reply.replies, is_starred=reply.is_starred, expanded=expanded, user=user, hide_delete=hide_delete %}
        {% include "partials/feed_item.html" %}
        {% endwith %}
        {% endfor %}
        {% endif %}
    </div>
</div>